/* Only works on x86_64 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>

#define PAGE_SIZE 0x1000
#define PAGE_ALIGN(m) (((m) + PAGE_SIZE - 1) & PAGE_SIZE)

const char magic[] =
    "\xbf\x01\x00\x00\x00\xc6\x44\x24\xff\x59\x48\x8d\x74\x24\xff\xba\x01\x00"
    "\x00\x00\x89\xf8\x0f\x05\xc6\x44\x24\xff\x6f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x75\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x61\x89\xf8\x0f\x05\xc6\x44\x24\xff\x63\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x74\x89\xf8\x0f\x05\xc6\x44\x24\xff\x75\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x61\x89\xf8\x0f\x05\xc6\x44\x24\xff\x6c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x6c\x89\xf8\x0f\x05\xc6\x44\x24\xff\x79\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x64\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x65\x89\xf8\x0f\x05\xc6\x44\x24\xff\x63\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x69\x89\xf8\x0f\x05\xc6\x44\x24\xff\x64\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x65\x89\xf8\x0f\x05\xc6\x44\x24\xff\x64\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x74\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x6f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x72\x89\xf8\x0f\x05\xc6\x44\x24\xff\x75\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x6e\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x74\x89\xf8\x0f\x05\xc6\x44\x24\xff\x68\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x69\x89\xf8\x0f\x05\xc6\x44\x24\xff\x73\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x21\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x57\x89\xf8\x0f\x05\xc6\x44\x24\xff\x48\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x41\x89\xf8\x0f\x05\xc6\x44\x24\xff\x54\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x49\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x46\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x49\x89\xf8\x0f\x05\xc6\x44\x24\xff\x54\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x48\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x41\x89\xf8\x0f\x05\xc6\x44\x24\xff\x44\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x53\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x48\x89\xf8\x0f\x05\xc6\x44\x24\xff\x45\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x4c\x89\xf8\x0f\x05\xc6\x44\x24\xff\x4c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x43\x89\xf8\x0f\x05\xc6\x44\x24\xff\x4f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x44\x89\xf8\x0f\x05\xc6\x44\x24\xff\x45\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2e\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x48\x89\xf8\x0f\x05\xc6\x44\x24\xff\x65\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x72\x89\xf8\x0f\x05\xc6\x44\x24\xff\x65\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x27\x89\xf8\x0f\x05\xc6\x44\x24\xff\x73\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x77\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x68\x89\xf8\x0f\x05\xc6\x44\x24\xff\x61\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x74\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x79\x89\xf8\x0f\x05\xc6\x44\x24\xff\x6f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x75\x89\xf8\x0f\x05\xc6\x44\x24\xff\x72\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x50\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x43\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x63\x89\xf8\x0f\x05\xc6\x44\x24\xff\x6f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x75\x89\xf8\x0f\x05\xc6\x44\x24\xff\x6c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x64\x89\xf8\x0f\x05\xc6\x44\x24\xff\x27\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x76\x89\xf8\x0f\x05\xc6\x44\x24\xff\x65\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x62\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x65\x89\xf8\x0f\x05\xc6\x44\x24\xff\x65\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x6e\x89\xf8\x0f\x05\xc6\x44\x24\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2e\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2e\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24\xff\x78\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2e\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x78\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2e\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2e\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x60\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x29\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x28\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x60\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5b\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x6f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24\xff\x5f\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3a\x89\xf8\x0f\x05\xc6\x44\x24\xff\x7c\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x5c\x89\xf8\x0f\x05\xc6\x44\x24\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24\xff\x20\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x60\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x3d\x89\xf8\x0f\x05\xc6\x44\x24\xff\x2d\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x60\x89\xf8\x0f\x05\xc6\x44\x24\xff\x28\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x29\x89\xf8\x0f\x05\xc6\x44\x24\xff\x0a\x89\xf8\x0f\x05\xc6\x44\x24"
    "\xff\x0a\x89\xf8\x0f\x05\xb8\x3c\x00\x00\x00\x31\xff\x0f\x05\xeb\xfe";

int main(int argc, char **argv) {
  void *fn = mmap(NULL, PAGE_ALIGN(sizeof(magic) - 1), PROT_WRITE,
                  MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
  memcpy(fn, magic, sizeof(magic));
  mprotect(fn, PAGE_ALIGN(sizeof(magic) - 1), PROT_EXEC | PROT_READ);
  if (mmap) {
    ((void (*)())fn)();
  }
}
